---
title: "本番運用とトラブルシューティング"
---

本番環境でのAtlasの運用方法とトラブルシューティングを解説します。実際のトラブル発生時の対応策や安全なロールバック手法を理解することで、安定した運用を実現できます。

## マイグレーション失敗時の対応策

本番DBでマイグレーションが失敗した場合の具体的な対応策を以下に示します。

1. **エラーログの確認**  
   まずAtlasやDBのエラーログを確認し、失敗原因を特定します。
   
   ```shell
   atlas migrate apply \
     --url "mysql://user:pass@prod-db:3306/mydb" \
     --dir "file://migrations" \
     --dry-run --log-level debug
   ```

2. **失敗したマイグレーションの特定と修正**  
   問題のあるマイグレーションを特定し、修正した新しいマイグレーションを生成します。

3. **ステージング環境での再確認**  
   修正後は必ずステージング環境でマイグレーションを再確認し、正常適用を確認します。

4. **本番環境への再適用**  
   本番環境に再度マイグレーションを適用します。

## 安全なロールバック方法

Atlasでロールバックを安全に行うには、以下のような戦略を推奨します。

- **明示的なロールバック用マイグレーションを作成する**  
  スキーマ変更の際は同時にロールバック用マイグレーションを作成し、いつでも戻れるようにします。

  ```sql
  -- up.sql
  ALTER TABLE users ADD COLUMN nickname VARCHAR(255);

  -- down.sql
  ALTER TABLE users DROP COLUMN nickname;
  ```

- **ロールバック手順をCI/CDに組み込む**  
  GitHub Actionsなどを利用し、ロールバックを自動化または半自動化する仕組みを用意します。

## スキーマのバージョニングと監査ログの活用法

スキーマのバージョニングと監査ログを活用することで、運用の透明性や障害対応の迅速性を向上できます。

### バージョニングの実践方法
Atlasはマイグレーションファイルの名前にタイムスタンプを使用します。これによりスキーマ変更履歴を一目で追跡できます。

```
migrations/
├── 20240321120000_add_nickname.sql
├── 20240322140000_remove_old_column.sql
└── atlas.sum
```

### 監査ログの利用
監査ログを保存することで、誰が、いつ、どのような変更をしたか明確にできます。CI/CDパイプライン上で、マイグレーション適用ログを外部ストレージ（例：S3やログ集約システム）に保存することを推奨します。

GitHub Actionsでのログ保存例:

```yaml
- name: Run Migration and Save Log
  run: |
    atlas migrate apply \
      --url "${{ secrets.DB_URL }}" \
      --dir "file://migrations" | tee migration.log
    aws s3 cp migration.log s3://my-audit-logs/${{ github.sha }}.log
```

これにより、スキーマ変更を後から安全かつ簡単に検証できます。

次の「おわりに」では、Atlas導入時の注意点や今後の活用方法をまとめます。
